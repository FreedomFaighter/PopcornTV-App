<!DOCTYPE html>
<html>
  <head>
    <title>PopcornTV v0.2.0</title>
    <style type="text/css">

    </style>
    <link rel="stylesheet" type="text/css" href="css/darkly.min.css">

    <script>
    	var gui = require('nw.gui');
		var win = gui.Window.get();
		var PopcornTV;

		function start(){
			var button = document.getElementById('status');
			button.textContent = 'Stop';
			button.setAttribute('onclick', 'stop();');
			button.className = 'btn btn-danger';

			PopcornTV = require('popcorntv');
			try{
				PopcornTV.start();
			} catch(e){
				stop();
			}
		};

		function stop(){
			var button = document.getElementById('status');
			button.textContent = 'Start';
			button.setAttribute('onclick', 'start();');
			button.className = 'btn btn-success';
			PopcornTV.stop();
			PopcornTV = null;
		};

		function installed(){
			try{
				var PopcornTV = require('popcorntv');
				return true;
			} catch(e) {
				console.log(e);
				return false;
			}
		}

		function install(){
			var npm = require('npm');

			var button = document.getElementById('install');
			button.textContent = 'Installing...';

			alert("Please follow the Installation instructions");

			var installWindow = gui.Window.open('file://' + process.cwd() + '/install/install.html', {
			  	position: 'center',
			  	toolbar: true,
			  	width: 800,
			  	height: 600
			});

			var button = document.getElementById('install');
			button.textContent = 'Update';
			button.setAttribute('onclick', 'update()');

			var button = document.getElementById('status');
			button.removeAttribute('disabled');

			installWindow.on('close', function(){
				start();
				openInstructions();
			})
		}

		function update(){
			var button = document.getElementById('install');
			button.textContent = 'Updating...';

			var npm = require('npm');

			npm.load(function (er) {
                if (er) return handlError(er)
				npm.commands.install(['popcorntv'], function (er, data) {
	                if (er) alert(er)
	                if (data) console.log(data);
	            	button.textContent = 'Updated!';
	            	setTimeout(function(){
	            		button.textContent = 'Update';
	            	}, 5000)
	            })
	        });
		}

		function openInstructions(){
			var installWindow = gui.Window.open('file://' + process.cwd() + '/install/step1.html', {
			  	position: 'center',
			  	toolbar: false,
			  	width: 800,
			  	height: 600
			});
		}

    </script>
  </head>
  <body>
  	<container>
	  	<div style="padding-top: 5%; padding-bottom: 10%;">
	  		<center>
		    	<img src='logo.png' height="75" />
		    </center>
	  	</div>
	    <div>
	    	<script>
	    		if (installed()){
	    			document.write('<button id="install" onclick="update()" class="btn btn-info" style="margin-left: 25%;">Update</button>');
	    		} else {
	    			document.write('<button id="install" onclick="install()" class="btn btn-info" style="margin-left: 25%;">Install</button>');
	    		}
	    	</script>
	    	<script>
	    		if (installed()){
	    			document.write('<button id="status" onclick="start();" class="btn btn-success" style="margin-left: 20%;">Start</button>');
	    		} else {
	    			document.write('<button id="status" onclick="" class="btn btn-success" style="margin-left: 20%;" disabled="disabled">Start</button>');
	    		}
	    	</script>
	    </div>

    </container>
  </body>
</html>